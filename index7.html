<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基本資料建立 (Master Data) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }
        
        /* 說明卡 */
        .master-info-card {
            background-color: #e0e7ff;
            border-left: 5px solid #4338ca;
            color: #312e81;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* 表格樣式 */
        .client-table th { background-color: #4f46e5; color: white; font-weight: 500; }
        .client-table tbody tr { transition: all 0.3s; }
        .client-table tbody tr:hover { background-color: #eef2ff; }
        
        /* 狀態標籤 */
        .status-active { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }
        .status-inactive { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }

        /* 新增資料的高亮動畫 */
        .new-row-highlight {
            animation: highlightRow 3s ease-out;
            background-color: #fef3c7; /* 初始黃色高亮 */
        }
        @keyframes highlightRow {
            0% { background-color: #fffbeb; }
            50% { background-color: #fef3c7; } 
            100% { background-color: transparent; }
        }

        /* Modal 分頁樣式 */
        .nav-tabs .nav-link { color: #6b7280; }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #4f46e5;
            border-top: 3px solid #4f46e5;
            background-color: #fff;
        }
        .form-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            margin-top: 1.5rem;
        }
        .form-section-title:first-child { margin-top: 0; }

        /* 上傳區塊 */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            background-color: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            if (!role || role === 'medical') {
                alert('權限不足：此頁面僅限管理人員與文管人員存取。');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
            const userName = sessionStorage.getItem('currentUserName') || 'User';
            document.getElementById('user-display').innerHTML = `<small>${role === 'admin' ? 'Admin' : '文管'}: ${userName}</small>`;
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fas fa-database me-2 text-indigo-600" style="color: #4f46e5;"></i>基本資料建立</h2>
                <p class="text-muted mb-0">客戶主檔管理與合約設定 (Master Data Management)</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary fw-bold" onclick="triggerImport()">
                    <i class="fas fa-file-import me-2"></i>匯入歷史資料 (AI)
                </button>
                <button class="btn btn-primary fw-bold" onclick="openCreateModal()">
                    <i class="fas fa-plus me-2"></i>新增事業單位
                </button>
            </div>
        </div>

        <input type="file" id="importInput" style="display: none;" onchange="simulateImportProcess()">

        <div class="master-info-card shadow-sm">
            <strong><i class="fas fa-magic me-2"></i>智慧建檔功能 (Smart Import)</strong><br>
            您可透過「匯入歷史資料」功能，直接上傳既有的<strong>「勞工健康服務執行紀錄表 (PDF)」</strong>。系統將自動解析文件內容，擷取員工人數、製程特性與危害分類，自動建立客戶主檔。
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body py-3">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0" placeholder="搜尋公司名稱、統編或合約編號...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select">
                            <option value="">所有合約狀態</option>
                            <option value="active">有效合約中</option>
                            <option value="expired">已過期</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table client-table mb-0 align-middle" id="clientTable">
                        <thead>
                            <tr>
                                <th class="ps-4">統一編號</th>
                                <th>事業單位名稱</th>
                                <th>合約編號</th>
                                <th>聯絡人</th>
                                <th>負責顧問</th>
                                <th>附件</th>
                                <th>合約期間</th>
                                <th>狀態</th>
                                <th class="text-end pe-4">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="ps-4 font-monospace">12345678</td>
                                <td class="fw-bold">ABCDEF有限公司</td>
                                <td class="small text-muted">CT-2024-001</td>
                                <td>陳經理</td>
                                <td><div class="d-flex align-items-center"><div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-2" style="width:24px;height:24px;font-size:10px;">王</div>王大明</div></td>
                                <td><i class="fas fa-paperclip text-primary"></i></td>
                                <td class="small text-muted">2024/01/01 ~ 2025/12/31</td>
                                <td><span class="status-active">合約中</span></td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-secondary me-1"><i class="fas fa-pen"></i></button>
                                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4 font-monospace">87654321</td>
                                <td class="fw-bold">XYZ 物流中心</td>
                                <td class="small text-muted">CT-2024-008</td>
                                <td>林小姐</td>
                                <td><div class="d-flex align-items-center"><div class="bg-success text-white rounded-circle d-flex justify-content-center align-items-center me-2" style="width:24px;height:24px;font-size:10px;">林</div>林美秀</div></td>
                                <td><span class="text-muted text-opacity-25"><i class="fas fa-paperclip"></i></span></td>
                                <td class="small text-muted">2024/06/01 ~ 2025/05/31</td>
                                <td><span class="status-active">合約中</span></td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-secondary me-1"><i class="fas fa-pen"></i></button>
                                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; text-align: center; padding-top: 20%;">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4 class="fw-bold text-dark">AI 正在解析文件內容...</h4>
        <p class="text-muted">正在擷取：統一編號、製程特性、危害風險分類</p>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>事業單位資料維護</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <ul class="nav nav-tabs px-4 pt-3 bg-light" id="myTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#basic">1. 基本資料</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#workplace">2. 作業場所資料</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#condition">3. 勞動條件概況</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#contract">4. 合約及附件</button></li>
                    </ul>
                    <div class="tab-content p-4" id="myTabContent">
                        
                        <div class="tab-pane fade show active" id="basic">
                            <h6 class="form-section-title">公司基本資料</h6>
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label fw-bold">統一編號 <span class="text-danger">*</span></label><input type="text" class="form-control"></div>
                                <div class="col-md-8"><label class="form-label fw-bold">事業單位名稱 <span class="text-danger">*</span></label><input type="text" class="form-control"></div>
                                <div class="col-md-12"><label class="form-label">公司地址</label><input type="text" class="form-control"></div>
                            </div>
                            <h6 class="form-section-title">聯絡窗口</h6>
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label">聯絡人</label><input type="text" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label">電話</label><input type="text" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label">Email</label><input type="email" class="form-control"></div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="workplace">
                            <h6 class="form-section-title">基本概況</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6"><label class="form-label">部門名稱</label><input type="text" class="form-control"></div>
                                <div class="col-md-6"><label class="form-label">一般作業人數</label><input type="number" class="form-control"></div>
                            </div>

                            <h6 class="form-section-title">勞工人數結構 (ABCDEF 格式)</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <h6 class="card-title text-muted small fw-bold">行政人員</h6>
                                            <div class="row">
                                                <div class="col-6"><label class="small">男</label><input type="number" class="form-control form-control-sm"></div>
                                                <div class="col-6"><label class="small">女</label><input type="number" class="form-control form-control-sm"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <h6 class="card-title text-muted small fw-bold">現場操作人員</h6>
                                            <div class="row">
                                                <div class="col-6"><label class="small">男</label><input type="number" class="form-control form-control-sm"></div>
                                                <div class="col-6"><label class="small">女</label><input type="number" class="form-control form-control-sm"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h6 class="form-section-title">特別危害健康作業</h6>
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label">1. 高溫 (人)</label><input type="number" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label">2. 噪音 (人)</label><input type="number" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label">3. 其他 (人)</label><input type="number" class="form-control"></div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="condition">
                            <h6 class="form-section-title">作業細節描述</h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold">1. 工作流程 (製程)</label>
                                <textarea class="form-control" rows="3" placeholder="例如：整經漿紗->織布->脫漿->成布加工..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">2. 工作型態與時間</label>
                                <textarea class="form-control" rows="2" placeholder="例如：行政人員常日班，產線人員輪值三班。"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">3. 潛在工作危害特性</label>
                                <textarea class="form-control" rows="3" placeholder="例如：高溫、噪音、人因性危害..."></textarea>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="contract">
                            <h6 class="form-section-title">合約與管理資訊</h6>
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label">合約編號</label><input type="text" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label">合約起始日</label><input type="date" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label">合約結束日</label><input type="date" class="form-control"></div>
                                <div class="col-md-6"><label class="form-label fw-bold">指派負責顧問</label><select class="form-select"><option>王大明 醫師</option><option>李雅婷 護理師</option></select></div>
                            </div>
                            <h6 class="form-section-title mt-4">文件歸檔</h6>
                            <div class="upload-zone" onclick="alert('開啟檔案選擇器')">
                                <i class="fas fa-file-contract fa-2x text-secondary mb-2"></i>
                                <p class="mb-0 text-muted small">合約影本上傳</p>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary fw-bold px-4" onclick="alert('新增成功！')">儲存資料</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function openCreateModal() {
            new bootstrap.Modal(document.getElementById('createModal')).show();
        }

        // 1. 觸發檔案選擇
        function triggerImport() {
            document.getElementById('importInput').click();
        }

        // 2. 模擬匯入流程 (使用 參考範例1.pdf 的數據)
        function simulateImportProcess() {
            const input = document.getElementById('importInput');
            if (input.files && input.files[0]) {
                // 顯示 Loading
                document.getElementById('loadingOverlay').style.display = 'block';

                setTimeout(() => {
                    // 隱藏 Loading
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    // 3. 動態新增一列 (模擬 0000公司 匯入)
                    const tbody = document.querySelector('#clientTable tbody');
                    const newRow = document.createElement('tr');
                    
                    // 加入動畫 Class
                    newRow.className = 'new-row-highlight animate__animated animate__fadeInUp'; 
                    
                    // 根據 [參考範例1.pdf] 填入數據 [cite: 59, 60]
                    // 公司名: 0000公司 -> 模擬為 0000科技有限公司
                    // 日期: 2022/01/01
                    newRow.innerHTML = `
                        <td class="ps-4 font-monospace">00001234</td>
                        <td class="fw-bold">0000科技有限公司 <span class="badge bg-primary bg-opacity-10 text-primary ms-2" style="font-size: 0.7rem;">New</span></td>
                        <td class="small text-muted">待補登</td>
                        <td>陳廠長 (系統帶入)</td>
                        <td><div class="d-flex align-items-center"><div class="bg-secondary text-white rounded-circle d-flex justify-content-center align-items-center me-2" style="width:24px;height:24px;font-size:10px;">待</div>指派中</div></td>
                        <td><i class="fas fa-file-pdf text-danger" title="來源文件：勞工健康服務執行紀錄表_參考範例1.pdf"></i></td>
                        <td class="small text-muted">2022/01/01 ~ 2022/12/31</td>
                        <td><span class="status-inactive">已過期</span></td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-secondary me-1"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    
                    tbody.appendChild(newRow);
                    
                    // 成功提示 (顯示擷取的重點資訊)
                    alert('匯入成功！\n\n系統已依據「勞工健康服務執行紀錄表_參考範例1.pdf」建立基本資料。\n\n[AI 擷取重點]\n● 公司名稱：0000科技有限公司\n● 員工總數：110 人 (行政50/現場60)\n● 危害風險：高溫(5人)、噪音(20人)\n● 製程特徵：紡織相關(漿紗/織布/染整)');
                    
                    // 捲動到底部
                    newRow.scrollIntoView({ behavior: 'smooth' });

                }, 1500); // 模擬運算時間
            }
        }
    </script>
</body>
</html>
