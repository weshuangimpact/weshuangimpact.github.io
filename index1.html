<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>顧問資料上傳 | OHSMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#f4f6f9; font-family:'Microsoft JhengHei'; display:none; }
.section-title { border-left:4px solid #0d6efd; padding-left:10px; font-weight:bold; margin:1.5rem 0; }
textarea { font-size:0.9rem; }
</style>

<script>
/* ===== Auth Guard ===== */
const role = sessionStorage.getItem('currentUserRole');
if (!role) location.href = 'login.html';

/* ===== Supabase ===== */
const supabase = supabase.createClient(
  'https://ghpxaeenikochgrnczic.supabase.co',
  'sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW'
);
</script>
</head>

<body>
<div class="container py-4">

<h3 class="fw-bold mb-2">顧問資料上傳（Plan / Do）</h3>
<p class="text-muted small mb-4">主文件辨識 → 辦理事項對帳 → 附件確認</p>

<!-- Step 1 -->
<div class="section-title">Step 1：上傳文件（可多檔）</div>
<div class="mb-3">
  <label class="form-label fw-bold small">主文件（勞工健康服務執行紀錄表）</label>
  <input type="file" id="mainFile" class="form-control" accept=".pdf,.jpg,.png">
</div>
<div class="mb-4">
  <label class="form-label fw-bold small">附件（可多檔）</label>
  <input type="file" id="attachments" class="form-control" multiple>
</div>

<!-- Step 2 -->
<div id="ocrSection" style="display:none;">
  <div class="section-title">Step 2：OCR 結果（可調整）</div>

  <label class="fw-bold small">執行日期</label>
  <input type="date" id="executionDate" class="form-control mb-3">

  <label class="fw-bold small">一、作業場所基本資料</label>
  <textarea id="sec1" class="form-control mb-3" rows="3"></textarea>

  <label class="fw-bold small">二、作業流程與危害概況</label>
  <textarea id="sec2" class="form-control mb-3" rows="3"></textarea>

  <label class="fw-bold small">三、臨場健康服務執行情形</label>
  <textarea id="sec3" class="form-control mb-4" rows="4"></textarea>

  <label class="fw-bold small mb-2">辦理事項（由系統判斷，可人工修正）</label>
  <div id="itemsArea" class="mb-4"></div>

  <button class="btn btn-primary fw-bold" onclick="submitAll()">確認送出審核</button>
</div>

</div>

<script>
document.body.style.display = 'block';

/* ===== 模擬後端 OCR 回傳（實際系統由 Edge Function 給）===== */
document.getElementById('mainFile').addEventListener('change', () => {
  const ocrResult = {
    execution_date: '2024-01-01',
    section_1: '部門：台南廠；行政人員 男20 女30；現場人員 男40 女20',
    section_2: '製程：整經→織布→脫漿→成布加工；主要危害：高溫、噪音',
    section_3: '9-1、9-3、9-6、11-1',
    checked_items: {
      '9-1': true,
      '9-2': false,
      '9-3': true,
      '9-6': true,
      '11-1': true,
      '12': false,
      '13': false
    }
  };

  document.getElementById('ocrSection').style.display = 'block';
  document.getElementById('executionDate').value = ocrResult.execution_date;
  document.getElementById('sec1').value = ocrResult.section_1;
  document.getElementById('sec2').value = ocrResult.section_2;
  document.getElementById('sec3').value = ocrResult.section_3;

  const itemsArea = document.getElementById('itemsArea');
  itemsArea.innerHTML = '';
  Object.keys(ocrResult.checked_items).forEach(code => {
    const checked = ocrResult.checked_items[code];
    itemsArea.innerHTML += `
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="item-${code}" ${checked ? 'checked' : ''}>
        <label class="form-check-label">${code}</label>
      </div>`;
  });
});

/* ===== 寫入 Supabase ===== */
async function submitAll() {
  const uploader = sessionStorage.getItem('currentUserName') || 'consultant';
  const mainFile = document.getElementById('mainFile').files[0];
  const attachmentFiles = document.getElementById('attachments').files;

  const checkedItems = {};
  document.querySelectorAll('[id^="item-"]').forEach(el => {
    checkedItems[el.id.replace('item-','')] = el.checked;
  });

  const { data: staging, error } = await supabase
    .from('document_staging')
    .insert({
      uploader_name: uploader,
      main_file_name: mainFile.name,
      main_file_type: mainFile.type,
      category: '勞工健康服務執行紀錄表',
      execution_date: document.getElementById('executionDate').value,
      extracted_data: {
        section_1: sec1.value,
        section_2: sec2.value,
        section_3: sec3.value,
        checked_items: checkedItems
      }
    })
    .select()
    .single();

  if (error) return alert(error.message);

  for (const f of attachmentFiles) {
    await supabase.from('document_attachments').insert({
      staging_id: staging.id,
      file_name: f.name,
      file_type: f.type
    });
  }

  for (const code in checkedItems) {
    await supabase.from('document_item_check').insert({
      staging_id: staging.id,
      item_code: code,
      is_checked: checkedItems[code],
      has_attachment: false,
      check_status: checkedItems[code] ? 'missing_attachment' : 'ok'
    });
  }

  alert('已送出審核');
  location.href = 'dashboard.html';
}
</script>
</body>
</html>
