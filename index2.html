<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者總覽 (Check/Act) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: #f4f6f9;
        }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }

        /* PDCA 說明字卡樣式 */
        .demo-info-card {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* 待辦卡片互動效果 */
        .task-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #0d6efd;
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        .task-card.priority-high {
            border-left-color: #dc3545; /* Red for high priority */
        }
        .task-card.priority-manual {
            border-left-color: #6f42c1; /* Purple for manual */
        }

        /* 行事曆時間軸樣式 */
        .timeline-item {
            border-left: 2px solid #dee2e6;
            padding-left: 1.5rem;
            padding-bottom: 1.5rem;
            position: relative;
        }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-marker {
            position: absolute;
            left: -0.4rem;
            top: 0;
            width: 0.8rem;
            height: 0.8rem;
            border-radius: 50%;
            background-color: #fff;
            border: 2px solid #0d6efd;
        }
        .timeline-marker.danger { border-color: #dc3545; background-color: #dc3545; }
        .timeline-marker.warning { border-color: #ffc107; background-color: #ffc107; }
        .timeline-marker.success { border-color: #198754; }

        /* 審查輸入框樣式 */
        .review-input-locked {
            background-color: transparent;
            border: none;
            font-weight: bold;
            color: #1e293b;
            width: 100%;
            pointer-events: none;
        }
        .review-input-unlocked {
            background-color: white;
            border: 1px solid #3b82f6;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            width: 100%;
            pointer-events: auto;
        }
    </style>

    <script>
        const role = sessionStorage.getItem('currentUserRole');
        // 嚴格限制：僅 Admin 或 Medical 可進入
        if (!role || role === 'general') {
            alert('權限不足：此頁面僅供管理人員訪問');
            window.location.href = 'dashboard.html';
        }
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fas fa-chart-pie me-2 text-success"></i>管理者總覽</h2>
                <p class="text-muted mb-0">Check & Act 階段：績效查核、歸檔審查與時程控管</p>
            </div>
            <div>
                <span class="badge bg-success bg-opacity-10 text-success fs-6 me-2">可評鑑: 12</span>
                <span class="badge bg-danger bg-opacity-10 text-danger fs-6">未完成: 3</span>
            </div>
        </div>

        <div class="demo-info-card">
            <i class="fas fa-gavel me-2"></i>
            <strong>PDCA 設計理念：Check & Act (查核與行動) —— 整合指揮中心</strong><br>
            此介面整合四大核心管理功能：<br>
            1. <strong>缺口分析 (Check)</strong>：即時比對法規要求，紅燈標示缺件。<br>
            2. <strong>歸檔審查 (Act)</strong>：人機協作審核 AI 辨識資料，確保資料庫品質 (Gatekeeping)。<br>
            3. <strong>法規排程 (Time)</strong>：自動監控法定申報與證照複訓日期。<br>
            4. <strong>進度跟催 (Follow-up)</strong>：<span class="text-danger fw-bold">NEW!</span> 針對未完成或審查中的案件，可直接點擊「跟催」按鈕，系統自動帶入顧問資訊，透過 Email 或簡訊發送提醒通知。
        </div>

        <div class="mb-5">
            <h5 class="fw-bold text-dark mb-3 d-flex align-items-center">
                <span class="badge bg-danger rounded-pill me-2" style="width: 10px; height: 10px; padding: 0;">&nbsp;</span>
                待歸檔資料通知
                <span class="badge bg-danger bg-opacity-10 text-danger ms-2 rounded-pill small">3 筆待辦</span>
            </h5>

            <div class="row g-4" id="notification-list">
                <div class="col-md-4">
                    <div class="card shadow-sm task-card bg-white" onclick="openArchivingReview('ABCDEF有限公司', '2024', '9-2 適性評估')">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary">AI 建議</span>
                                <small class="text-muted">10 分鐘前</small>
                            </div>
                            <h5 class="card-title fw-bold text-dark">ABCDEF有限公司</h5>
                            <div class="text-muted small mt-2">
                                <div class="mb-1"><i class="far fa-calendar me-2"></i>2024 年度</div>
                                <div><i class="fas fa-tag me-2"></i>9-2 適性評估</div>
                            </div>
                            <div class="border-top mt-3 pt-3 text-center text-primary fw-bold small">
                                點擊進行審查與歸檔 <i class="fas fa-arrow-right ms-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm task-card bg-white" onclick="openArchivingReview('XYZ物流中心', '2024', '9-3 異常追蹤')">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary">AI 建議</span>
                                <small class="text-muted">2 小時前</small>
                            </div>
                            <h5 class="card-title fw-bold text-dark">XYZ物流中心</h5>
                            <div class="text-muted small mt-2">
                                <div class="mb-1"><i class="far fa-calendar me-2"></i>2024 年度</div>
                                <div><i class="fas fa-tag me-2"></i>9-3 異常追蹤</div>
                            </div>
                            <div class="border-top mt-3 pt-3 text-center text-primary fw-bold small">
                                點擊進行審查與歸檔 <i class="fas fa-arrow-right ms-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm task-card priority-manual bg-white" onclick="openArchivingReview('TopTech電子', '2025', '11-1 危害辨識')">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-purple bg-opacity-10 text-purple" style="color: #6f42c1; background-color: #f3ebff;">人工上傳</span>
                                <small class="text-muted">昨天</small>
                            </div>
                            <h5 class="card-title fw-bold text-dark">TopTech電子</h5>
                            <div class="text-muted small mt-2">
                                <div class="mb-1"><i class="far fa-calendar me-2"></i>2025 年度</div>
                                <div><i class="fas fa-tag me-2"></i>11-1 危害辨識</div>
                            </div>
                            <div class="border-top mt-3 pt-3 text-center text-primary fw-bold small">
                                點擊進行審查與歸檔 <i class="fas fa-arrow-right ms-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-dark"><i class="far fa-calendar-alt me-2 text-primary"></i>法規作業行事曆</h5>
                        <select class="form-select form-select-sm" style="width: auto;">
                            <option>2026年 1月</option>
                            <option>2026年 2月</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="ps-2">
                            <div class="timeline-item">
                                <div class="timeline-marker danger"></div>
                                <div class="d-flex justify-content-between mb-1">
                                    <h6 class="fw-bold text-danger mb-0">急救人員證照複訓 (3人)</h6>
                                    <small class="text-danger fw-bold">已逾期 (1/15)</small>
                                </div>
                                <p class="text-muted small mb-2">王小明、李大華、張三 證照效期已過，請盡速安排。</p>
                                <button class="btn btn-sm btn-outline-danger" onclick="openFollowUpModal('公司內部', '人資部 張經理')">發送催辦通知</button>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-marker warning"></div>
                                <div class="d-flex justify-content-between mb-1">
                                    <h6 class="fw-bold text-dark mb-0">第四季 職安衛委員會會議</h6>
                                    <small class="text-warning fw-bold text-dark">剩餘 3 天 (1/26)</small>
                                </div>
                                <p class="text-muted small mb-0">地點：第一會議室。主席：總經理。需準備：上季檢討報告。</p>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-marker success"></div>
                                <div class="d-flex justify-content-between mb-1">
                                    <h6 class="fw-bold text-dark mb-0">職醫臨場服務 (1月場次)</h6>
                                    <small class="text-muted">預定 1/30</small>
                                </div>
                                <p class="text-muted small mb-0">預約人數：5人。重點：過勞量表異常訪談。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-header bg-transparent border-0 py-3">
                        <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-bell me-2 text-warning"></i>合規預警看板</h5>
                    </div>
                    <div class="card-body pt-0">
                        <div class="alert alert-danger bg-white border-danger mb-3 shadow-sm">
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                <strong class="text-danger">立即處理</strong>
                            </div>
                            <small class="d-block text-muted mb-2">ABCDEF有限公司「母性保護計畫」尚未更新至最新法規版本。</small>
                            <a href="#" class="btn btn-danger btn-sm w-100 py-0" style="font-size: 0.8rem;">前往更新計畫</a>
                        </div>
                        <div class="alert alert-warning bg-white border-warning mb-3 shadow-sm">
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-clock text-warning me-2"></i>
                                <strong class="text-dark">即將到期</strong>
                            </div>
                            <small class="d-block text-muted">年度健康檢查報告分析 (法規要求: 1/31 前完成)。</small>
                        </div>
                        <div class="d-flex justify-content-between text-center mt-4">
                            <div class="w-50 border-end">
                                <h3 class="fw-bold text-dark mb-0">98%</h3>
                                <small class="text-muted">本月合規率</small>
                            </div>
                            <div class="w-50">
                                <h3 class="fw-bold text-success mb-0">0</h3>
                                <small class="text-muted">重大缺失</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light py-3">
                <h5 class="mb-0 fw-bold text-dark">各事業單位評鑑資料完成度總覽</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary">
                            <tr>
                                <th class="ps-4 py-3">事業單位</th>
                                <th>年度</th>
                                <th>已完成項目數</th>
                                <th>缺件項目</th>
                                <th class="text-center">狀態</th>
                                <th class="text-center pe-4" style="width: 120px;">管理</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="ps-4 fw-bold">ABCDEF有限公司</td>
                                <td>2024</td>
                                <td>15 / 15</td>
                                <td class="text-success">無</td>
                                <td class="text-center"><span class="badge bg-success bg-opacity-10 text-success">資料齊備</span></td>
                                <td class="text-center pe-4">
                                    <button class="btn btn-sm btn-secondary w-100" disabled>已結案</button>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4 fw-bold">XYZ 物流中心</td>
                                <td>2024</td>
                                <td>2 / 6</td>
                                <td class="text-danger fw-bold">9-2, 9-3</td>
                                <td class="text-center"><span class="badge bg-danger bg-opacity-10 text-danger">未完成</span></td>
                                <td class="text-center pe-4">
                                    <button class="btn btn-sm btn-outline-danger w-100" onclick="openFollowUpModal('XYZ 物流中心', '王大明 醫師')">
                                        <i class="fas fa-bullhorn me-1"></i>跟催
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4 fw-bold">TopTech電子</td>
                                <td>2025</td>
                                <td>8 / 12</td>
                                <td class="text-warning text-dark">11-1 審查中</td>
                                <td class="text-center"><span class="badge bg-warning bg-opacity-10 text-warning text-dark">進行中</span></td>
                                <td class="text-center pe-4">
                                    <button class="btn btn-sm btn-outline-warning text-dark w-100" onclick="openFollowUpModal('TopTech電子', '張志明 職衛師')">
                                        <i class="fas fa-bullhorn me-1"></i>跟催
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="archivingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fs-6 fw-bold"><i class="fas fa-file-signature me-2"></i>資料歸檔審查</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <div class="alert alert-primary d-flex align-items-start border-primary border-start border-4" role="alert">
                        <i class="fas fa-robot text-primary mt-1 me-3 fs-5"></i>
                        <div>
                            <h6 class="fw-bold mb-1">AI 預判分類結果</h6>
                            <small>系統依據文件內容自動填寫以下欄位，請管理者確認是否正確。如需調整，請點擊「修改」按鈕。</small>
                        </div>
                    </div>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="small text-muted fw-bold text-uppercase">事業單位</label>
                                <input type="text" id="review-company" class="review-input-locked" value="ABCDEF有限公司" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted fw-bold text-uppercase">歸檔年度</label>
                                <input type="text" id="review-year" class="review-input-locked" value="2024" readonly>
                            </div>
                            <div class="mb-0">
                                <label class="small text-muted fw-bold text-uppercase">歸檔類別</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="review-category" class="review-input-locked" value="9-2 適性評估" readonly>
                                    <span class="badge bg-success bg-opacity-10 text-success ms-2 border border-success" id="confidence-badge">信心度 98%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-outline-secondary flex-fill" id="btn-modify" onclick="toggleArchivingEdit()">
                        <i class="fas fa-pen-to-square me-2"></i>修改
                    </button>
                    <button type="button" class="btn btn-outline-secondary flex-fill" onclick="openPdfModal()">
                        <i class="fas fa-eye me-2"></i>預覽文件
                    </button>
                    <button type="button" class="btn btn-primary flex-fill fw-bold" onclick="confirmArchiving()">
                        <i class="fas fa-check me-2"></i>確認並歸檔
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="followUpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fs-6 fw-bold"><i class="fas fa-bullhorn me-2"></i>進度跟催通知</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">收件人 (負責顧問)</label>
                        <input type="text" class="form-control" id="followUpConsultant" value="王大明 醫師" readonly>
                        <div class="form-text">系統自動帶入該專案負責顧問</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">發送方式</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="contactType" id="typeEmail" value="email" checked onchange="updateMessagePreview()">
                                <label class="form-check-label" for="typeEmail"><i class="fas fa-envelope me-1"></i>Email</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="contactType" id="typeSMS" value="sms" onchange="updateMessagePreview()">
                                <label class="form-check-label" for="typeSMS"><i class="fas fa-sms me-1"></i>簡訊 (SMS)</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label text-muted small fw-bold">訊息內容預覽</label>
                        <textarea class="form-control bg-light" id="messagePreview" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger fw-bold" onclick="sendFollowUp()">
                        <i class="fas fa-paper-plane me-2"></i>立即發送
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pdfModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content h-100">
                <div class="modal-header bg-secondary text-white py-2">
                    <h6 class="modal-title" id="pdfModalTitle">文件預覽</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary bg-opacity-10 d-flex align-items-center justify-content-center" style="min-height: 500px;">
                    <div class="text-center text-muted">
                        <i class="far fa-file-pdf fa-5x mb-3"></i>
                        <h5>PDF 文件預覽區 (Demo)</h5>
                        <p>此處將顯示實際文件內容</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            document.body.style.display = 'block';
            const userName = sessionStorage.getItem('currentUserName') || 'Admin';
            document.getElementById('user-display').innerHTML = `<small>管理者: ${userName}</small>`;
        });

        // 1. 開啟審查 Modal
        let currentReviewCard = null; 
        let archivingModal; 

        function openArchivingReview(company, year, category) {
            currentReviewCard = event.currentTarget;
            document.getElementById('review-company').value = company;
            document.getElementById('review-year').value = year;
            document.getElementById('review-category').value = category;
            
            isReviewEditing = false;
            updateReviewFieldsState();

            archivingModal = new bootstrap.Modal(document.getElementById('archivingModal'));
            archivingModal.show();
        }

        // 2. 編輯模式切換
        let isReviewEditing = false;
        function toggleArchivingEdit() {
            isReviewEditing = !isReviewEditing;
            updateReviewFieldsState();
        }

        function updateReviewFieldsState() {
            const inputs = ['review-company', 'review-year', 'review-category'];
            const btn = document.getElementById('btn-modify');
            
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (isReviewEditing) {
                    el.readOnly = false;
                    el.classList.remove('review-input-locked');
                    el.classList.add('review-input-unlocked');
                } else {
                    el.readOnly = true;
                    el.classList.remove('review-input-unlocked');
                    el.classList.add('review-input-locked');
                }
            });

            if (isReviewEditing) {
                btn.innerHTML = '<i class="fas fa-save me-2"></i>儲存';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-warning');
            } else {
                btn.innerHTML = '<i class="fas fa-pen-to-square me-2"></i>修改';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-outline-secondary');
            }
        }

        // 3. 確認歸檔
        function confirmArchiving() {
            alert('系統訊息：\n\n已成功歸檔！\n資料已寫入正式資料庫並產生稽核紀錄。');
            const modalEl = document.getElementById('archivingModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            if(currentReviewCard) {
                currentReviewCard.closest('.col-md-4').style.display = 'none';
                const badge = document.querySelector('.badge.bg-danger.bg-opacity-10');
                if(badge) badge.textContent = "2 筆待辦";
            }
        }

        // 4. 開啟跟催 Modal [New Feature]
        let currentFollowUpCompany = "";
        
        function openFollowUpModal(company, consultant) {
            currentFollowUpCompany = company;
            document.getElementById('followUpConsultant').value = consultant;
            updateMessagePreview(); // 初始化訊息內容
            
            const modal = new bootstrap.Modal(document.getElementById('followUpModal'));
            modal.show();
        }

        function updateMessagePreview() {
            const type = document.querySelector('input[name="contactType"]:checked').value;
            const consultant = document.getElementById('followUpConsultant').value;
            const textarea = document.getElementById('messagePreview');
            
            if (type === 'email') {
                textarea.value = `主旨：[OHSMS系統通知] ${currentFollowUpCompany} 臨場服務案件資料缺件提醒\n\n親愛的 ${consultant} 您好：\n系統偵測到您負責的「${currentFollowUpCompany}」案件尚有部分法定文件未上傳。請盡速登入系統補件，以免影響評鑑進度。\n\nOHSMS 管理中心 敬上`;
            } else {
                textarea.value = `[OHSMS通知] ${consultant}您好，${currentFollowUpCompany} 案件尚有缺件，請盡速至系統補件。`;
            }
        }

        function sendFollowUp() {
            const type = document.querySelector('input[name="contactType"]:checked').value;
            const contactMethod = type === 'email' ? 'Email' : '簡訊';
            alert(`系統訊息：\n\n跟催通知已透過 ${contactMethod} 成功發送！`);
            
            const modalEl = document.getElementById('followUpModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        }

        // 5. PDF 預覽
        function openPdfModal() {
            const pdfModal = new bootstrap.Modal(document.getElementById('pdfModal'));
            pdfModal.show();
        }
    </script>
</body>
</html>
