<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Safety Governance Demo (v1.2)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide React Icons (UMD) -->
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>

    <style>
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        // 1. Destructure Hooks & Globals
        const { useState, useEffect, useRef } = React;
        
        // 2. Destructure Icons from global lucideReact object
        const { 
            Send, 
            Shield, 
            AlertTriangle, 
            MessageSquare, 
            Activity, 
            User, 
            CheckCircle 
        } = window.lucideReact;

        // --- 配置與資料 ---

        // v1.2 冷靜支持模板 (L2 風險觸發使用)
        const SOFT_SUPPORT_TEMPLATE = {
            title: "安全提醒與支持",
            body: `我無法繼續以自動方式回應這類內容，但你現在的感受是重要的，也值得被認真對待。\n\n如果你正承受難以承受的痛苦，請優先考慮與真人支持資源聯繫。\n\n在台灣：\n- 張老師 1980\n- 生命線 1995\n- 若有立即危險，請撥 110 或 119\n\n如果你願意，我可以協助你把目前的狀況整理成幾句話，方便你轉交給真人諮詢對象。`
        };

        // [新] 深度同理回應庫 (針對挫折、失敗感、人際困擾 - 優先延續話題)
        const EMPATHY_RESPONSES = [
            "聽起來你投入了非常多的心力，但結果卻不如預期，這種「付出卻落空」的失落感一定很重。願意多說說讓你覺得「最失敗」的那個瞬間是什麼感覺嗎？",
            "被一直拒絕確實會嚴重打擊自信心，特別是你已經盡力嘗試了各種方法。這種無力感是可以被理解的。你現在心裡是不是覺得有點委屈？",
            "付出了金錢和時間卻得到這樣的結果，難怪你會覺得疲憊和受挫。這不是你的錯，感情的互動有時候真的很難由單方面控制。這段時間你辛苦了。",
            "我很遺憾聽到你這麼說。這種「覺得自己失敗」的感覺，往往比事件本身更讓人難受。我們不需要急著好起來，我會在這裡陪你消化這種感覺。"
        ];

        // [新] 一般引導與轉移回應庫 (針對一般閒聊或模糊情緒 - 軟性轉移)
        const GENERAL_RESPONSES = [
            // 軟性轉移 - 音樂
            "這些情緒確實很消耗能量。在我們慢慢梳理這些想法的同時，我想問問，最近有沒有哪首旋律是能讓你稍微感到平靜一點的？有時候給大腦一點聽覺的空間會有些幫助。",
            
            // 軟性轉移 - 興趣
            "處理這些複雜的感受真的很不容易。如果暫時讓自己從這個迴圈抽離一下下，最近有沒有什麼劇或電影是你稍微感興趣的？",
            
            // 認知重框
            "能察覺到這些情緒並表達出來，其實代表你很重視自己的狀態，這已經是自我照顧很好的第一步了。",
            
            // 問題拆解
            "這種感覺確實很複雜，也不容易釐清。我們先慢慢來，你覺得目前最讓你困擾的是哪個部分？"
        ];

        // 關鍵字偵測配置
        const RISK_KEYWORDS = ["痛苦", "自殺", "結束生命", "想死", "活不下去", "pain", "die", "kill"];
        const SADNESS_KEYWORDS = ["失敗", "拒絕", "沒用", "浪費", "花錢", "疲憊", "累", "難過", "傷心"];

        // --- 主應用程式元件 ---

        function App() {
            const [activeTab, setActiveTab] = useState('user'); // 'user' | 'admin'
            const [messages, setMessages] = useState([
                { id: 1, role: 'system', content: '您好，我是 AI 輔助系統。我可以陪您聊聊，或協助整理思緒。請放心，這裡是一個安全的空間。', timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) }
            ]);
            const [alerts, setAlerts] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);

            // 自動捲動到底部
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // 處理訊息發送
            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!inputValue.trim()) return;

                const userText = inputValue;
                const msgId = Date.now();
                const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // 1. 新增使用者訊息
                setMessages(prev => [...prev, { id: msgId, role: 'user', content: userText, timestamp }]);
                setInputValue('');
                setIsTyping(true);

                // 模擬網路延遲與思考
                setTimeout(() => {
                    processSystemResponse(userText, msgId, timestamp);
                }, 1000);
            };

            // 系統核心邏輯 (模擬 Adjudicator + 簡單 NLP 分類)
            const processSystemResponse = (text, caseId, time) => {
                setIsTyping(false);
                
                // 1. 偵測 L2 風險 (最高優先級)
                const detectedRisk = RISK_KEYWORDS.some(kw => text.includes(kw));
                
                // 2. 偵測挫折情緒 (次要優先級 - 用於選擇 L1 回應策略)
                const detectedSadness = SADNESS_KEYWORDS.some(kw => text.includes(kw));
                
                const riskLevel = detectedRisk ? 2 : 1;

                if (riskLevel >= 2) {
                    // === L2 觸發：冷靜治理流程 ===
                    setMessages(prev => [...prev, { 
                        id: Date.now(), 
                        role: 'assistant', 
                        content: SOFT_SUPPORT_TEMPLATE.body, 
                        isSupportTemplate: true,
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    }]);

                    const newAlert = {
                        id: `alert-${Date.now()}`,
                        caseId: caseId,
                        riskLevel: 2,
                        reason: "HIGH_RISK_DETECTED",
                        summary: text,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    };
                    setAlerts(prev => [newAlert, ...prev]);

                } else {
                    // === L1 安全：依據情緒選擇回應策略 ===
                    
                    let selectedResponse;

                    if (detectedSadness) {
                        // [策略 A] 偵測到具體挫折 -> 強制使用「深度同理回應」
                        selectedResponse = EMPATHY_RESPONSES[Math.floor(Math.random() * EMPATHY_RESPONSES.length)];
                    } else {
                        // [策略 B] 一般對話 -> 混合使用「一般引導」與「軟性轉移」
                        selectedResponse = GENERAL_RESPONSES[Math.floor(Math.random() * GENERAL_RESPONSES.length)];
                    }
                    
                    setMessages(prev => [...prev, { 
                        id: Date.now(), 
                        role: 'assistant', 
                        content: selectedResponse, 
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    }]);
                }
            };

            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden">
                    
                    {/* 左側導航 */}
                    <nav className="w-16 bg-slate-900 flex flex-col items-center py-6 space-y-8 flex-shrink-0 z-10">
                        <div className="text-slate-100 p-2 bg-slate-800 rounded-xl">
                            <Activity size={24} />
                        </div>
                        <button 
                            onClick={() => setActiveTab('user')}
                            className={`p-3 rounded-xl transition-all ${activeTab === 'user' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}
                            title="User Interface"
                        >
                            <MessageSquare size={24} />
                        </button>
                        <button 
                            onClick={() => setActiveTab('admin')}
                            className={`p-3 rounded-xl transition-all relative ${activeTab === 'admin' ? 'bg-amber-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}
                            title="Governance Console"
                        >
                            <Shield size={24} />
                            {alerts.filter(a => a.status === 'pending').length > 0 && (
                                <span className="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-slate-900"></span>
                            )}
                        </button>
                    </nav>

                    {/* 主內容區域 */}
                    <main className="flex-1 flex flex-col h-full relative">
                        
                        {/* --- 使用者介面 --- */}
                        {activeTab === 'user' && (
                            <div className="flex flex-col h-full max-w-2xl mx-auto w-full bg-white shadow-xl border-x border-slate-200">
                                {/* Header */}
                                <header className="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-white z-10">
                                    <div className="flex items-center space-x-3">
                                        <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                            <User size={20} />
                                        </div>
                                        <div>
                                            <h1 className="font-semibold text-slate-800">AI 諮詢夥伴</h1>
                                            <div className="flex items-center text-xs text-green-600">
                                                <span className="w-2 h-2 bg-green-500 rounded-full mr-1.5 animate-pulse"></span>
                                                Online
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-xs text-slate-400 border border-slate-200 px-2 py-1 rounded">
                                        v1.2 Calm Mode
                                    </div>
                                </header>

                                {/* Chat Area */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50">
                                    {messages.map((msg) => (
                                        <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`flex max-w-[85%] ${msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'} items-start gap-3`}>
                                                
                                                {/* Avatar */}
                                                <div className={`w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center mt-1 ${
                                                    msg.role === 'user' ? 'bg-slate-200 text-slate-600' : 'bg-blue-600 text-white'
                                                }`}>
                                                    {msg.role === 'user' ? <User size={14} /> : <Activity size={14} />}
                                                </div>

                                                {/* Bubble */}
                                                <div className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                                    <div className={`px-4 py-3 rounded-2xl text-sm leading-relaxed whitespace-pre-wrap shadow-sm ${
                                                        msg.role === 'user' 
                                                            ? 'bg-slate-800 text-white rounded-tr-none' 
                                                            : msg.isSupportTemplate 
                                                                ? 'bg-white border-l-4 border-blue-400 text-slate-700 rounded-tl-none'
                                                                : 'bg-white border border-slate-100 text-slate-700 rounded-tl-none'
                                                    }`}>
                                                        {msg.content}
                                                    </div>
                                                    <span className="text-[10px] text-slate-400 mt-1 px-1">
                                                        {msg.timestamp}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {isTyping && (
                                        <div className="flex justify-start items-center gap-3 animate-pulse">
                                            <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white opacity-50">
                                                <Activity size={14} />
                                            </div>
                                            <div className="text-xs text-slate-400">正在思考回應...</div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* Input Area */}
                                <div className="p-4 bg-white border-t border-slate-100">
                                    <form onSubmit={handleSendMessage} className="relative flex items-center gap-2">
                                        <input
                                            type="text"
                                            value={inputValue}
                                            onChange={(e) => setInputValue(e.target.value)}
                                            placeholder="輸入訊息... (試試輸入「我花了很多錢卻被拒絕，覺得很失敗」)"
                                            className="flex-1 bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all placeholder:text-slate-400"
                                        />
                                        <button 
                                            type="submit" 
                                            disabled={!inputValue.trim()}
                                            className="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg active:scale-95"
                                        >
                                            <Send size={18} />
                                        </button>
                                    </form>
                                    <div className="text-center mt-2">
                                        <p className="text-[10px] text-slate-400">此系統由 v1.2-calm-governance 驅動。所有對話均受隱私協議保護。</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- 管理者介面 --- */}
                        {activeTab === 'admin' && (
                            <div className="flex flex-col h-full bg-slate-50">
                                <header className="bg-white border-b border-slate-200 px-8 py-5 flex justify-between items-center shadow-sm">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                            <Shield className="text-amber-600" size={24} />
                                            Governance Console
                                        </h2>
                                        <p className="text-sm text-slate-500 mt-1">Out-of-Band Human Escalation System</p>
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex flex-col items-end">
                                            <span className="text-xs text-slate-400 uppercase tracking-wider font-semibold">Active Cases</span>
                                            <span className="text-lg font-bold text-slate-700">1</span>
                                        </div>
                                        <div className="w-px h-10 bg-slate-200"></div>
                                        <div className="flex flex-col items-end">
                                            <span className="text-xs text-slate-400 uppercase tracking-wider font-semibold">Pending Alerts</span>
                                            <span className="text-lg font-bold text-amber-600">{alerts.filter(a => a.status === 'pending').length}</span>
                                        </div>
                                    </div>
                                </header>

                                <div className="flex-1 overflow-auto p-8">
                                    <div className="max-w-5xl mx-auto">
                                        <h3 className="text-sm font-semibold text-slate-500 mb-4 uppercase tracking-wider flex items-center gap-2">
                                            <AlertTriangle size={16} />
                                            Risk Incidents Log
                                        </h3>

                                        {alerts.length === 0 ? (
                                            <div className="bg-white border border-slate-200 border-dashed rounded-lg p-12 text-center">
                                                <CheckCircle className="mx-auto text-slate-300 mb-3" size={48} />
                                                <p className="text-slate-500">目前沒有需要介入的高風險案件。</p>
                                                <p className="text-xs text-slate-400 mt-1">系統持續監控中 (Mode: Silent Monitor)</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {alerts.map((alert) => (
                                                    <div key={alert.id} className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                                                        <div className="flex flex-col md:flex-row">
                                                            <div className={`w-full md:w-2 bg-amber-500 flex-shrink-0`}></div>
                                                            
                                                            <div className="p-5 flex-1">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded border border-amber-200">
                                                                            L{alert.riskLevel} DETECTED
                                                                        </span>
                                                                        <span className="text-xs font-mono text-slate-400">Case ID: {alert.caseId}</span>
                                                                    </div>
                                                                    <span className="text-xs text-slate-400 flex items-center gap-1">
                                                                        {new Date(alert.timestamp).toLocaleString()}
                                                                    </span>
                                                                </div>

                                                                <h4 className="font-semibold text-slate-800 mb-1">Reason: {alert.reason}</h4>
                                                                
                                                                <div className="bg-slate-50 border border-slate-100 rounded p-3 my-3 text-sm text-slate-600 italic">
                                                                    "{alert.summary}"
                                                                </div>

                                                                <div className="flex items-center justify-between mt-4 pt-3 border-t border-slate-100">
                                                                    <div className="text-xs text-slate-500">
                                                                        System Action: <span className="font-semibold text-blue-600">Soft Template Sent</span>
                                                                    </div>
                                                                    <div className="flex gap-2">
                                                                        <button className="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-50 transition-colors">
                                                                            View Full Transcript
                                                                        </button>
                                                                        <button 
                                                                            className="text-xs bg-amber-600 text-white px-3 py-1.5 rounded hover:bg-amber-700 transition-colors flex items-center gap-1"
                                                                            onClick={() => {
                                                                                setAlerts(prev => prev.map(a => a.id === alert.id ? {...a, status: 'reviewed'} : a));
                                                                            }}
                                                                        >
                                                                            {alert.status === 'pending' ? 'Mark Reviewed' : 'Reviewed'}
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
