<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>附表八 勞工健康服務執行紀錄表</title>
    
    <!-- 1. 引入 Tailwind CSS (樣式框架) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 核心 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 引入 Babel (讓瀏覽器看不懂的 JSX 變成看得懂的 JS) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. 引入 PDF 生成工具 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* 字體設定 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .font-kai {
            font-family: "DFKai-SB", "BiauKai", "標楷體", serif;
        }

        /* 列印專用樣式 */
        @media print {
            body { background: white; padding: 0; }
            #root > div { padding: 0 !important; background: white !important; }
            #print-area { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 100% !important; 
                max-width: none !important;
                padding: 0 !important; 
            }
            .no-print { display: none !important; }
            
            /* 強制隱藏 Placeholder */
            input::placeholder, textarea::placeholder {
                color: transparent !important;
            }
            
            /* 強制背景列印 */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* 螢幕顯示時的 Placeholder 顏色 (藍色提示) */
        .placeholder-blue-400::placeholder {
            color: #60a5fa; /* Tailwind blue-400 */
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 內嵌 SVG 圖示元件 (取代 lucide-react 以確保單檔運作) ---
        const IconSave = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        );
        const IconDownload = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        );
        const IconTrash = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
        );
        const IconFileText = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
        );

        // --- 主程式 ---
        const App = () => {
            // 依照「附表八」定義初始狀態
            const initialData = {
                // 一、作業場所基本資料
                deptName: '',
                
                // 行政人員
                worker_admin: false,
                worker_admin_male: '',
                worker_admin_female: '',
                
                // 現場操作人員
                worker_site: false,
                worker_site_male: '',
                worker_site_female: '',
                
                // 作業類別
                job_general_count: '', // 一般作業人數
                
                job_special: false,    // 特別危害健康作業
                job_special_cat: '',   // 類別
                job_special_count: '', // 人數

                // 二、作業場所與勞動條件概況
                conditions_overview: '',

                // 三、臨場健康服務執行情形
                execution_items: '',   // (一)辦理事項
                problems_found: '',    // (二)發現問題

                // 四、建議採行措施
                measures: '',

                // 五、追蹤辦理情形
                tracking: '',

                // 六、執行人員及日期
                sign_doc: false,    // 醫師
                sign_nurse: false,  // 護理人員
                sign_related: false,// 相關人員
                sign_osha: false,   // 職安衛人員
                sign_hr: false,     // 人資

                // 部門主管簽核
                sup_dept_name: '',
                sup_title: '',
                sup_sign: '',

                // 時間日期
                time_start_h: '',
                time_start_m: '',
                time_end_h: '',
                time_end_m: '',
                exec_year: '',
                exec_month: '',
                exec_day: ''
            };

            const [formData, setFormData] = useState(initialData);
            const [isSaving, setIsSaving] = useState(false);
            const [lastSavedTime, setLastSavedTime] = useState(null);

            // 讀取暫存
            useEffect(() => {
                const saved = localStorage.getItem('healthRecordDraft_v2'); 
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setFormData(parsed);
                        const time = localStorage.getItem('healthRecordTime_v2');
                        if (time) setLastSavedTime(time);
                    } catch (e) {
                        console.error("讀取失敗", e);
                    }
                }
            }, []);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const handleSaveDraft = () => {
                setIsSaving(true);
                localStorage.setItem('healthRecordDraft_v2', JSON.stringify(formData));
                const now = new Date().toLocaleString('zh-TW');
                localStorage.setItem('healthRecordTime_v2', now);
                setLastSavedTime(now);
                setTimeout(() => setIsSaving(false), 500);
            };

            const handleClear = () => {
                if(window.confirm('確定要清除所有內容與暫存檔嗎？')) {
                    setFormData(initialData);
                    localStorage.removeItem('healthRecordDraft_v2');
                    localStorage.removeItem('healthRecordTime_v2');
                    setLastSavedTime(null);
                }
            };

            const handleDownloadPDF = () => {
                const element = document.getElementById('print-area');
                
                // 暫時強制顯示所有輸入框的邊框顏色為黑，避免 PDF 輸出過淡
                // 這裡使用 html2pdf 的設定
                const opt = {
                    margin:       10, // mm
                    filename:     `附表八_勞工健康服務執行紀錄_${formData.exec_year || '113'}年.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, logging: false },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                if (window.html2pdf) {
                    // 執行轉換
                    window.html2pdf().set(opt).from(element).save();
                } else {
                    alert("PDF 模組尚未載入完成，請重新整理頁面後再試。");
                }
            };

            // 樣式 Helper
            const cellLabel = "bg-gray-100 border-r border-black p-2 flex items-center justify-center font-bold text-sm text-center";
            const borderB = "border-b border-black";
            const placeholderClass = "placeholder-blue-400 print:placeholder-transparent";

            return (
                <div className="min-h-screen p-4 font-sans text-gray-800">
                    
                    {/* 操作工具列 (列印時隱藏) */}
                    <div className="no-print max-w-[210mm] mx-auto mb-6 bg-white p-4 rounded-lg shadow flex flex-wrap justify-between items-center gap-4 sticky top-0 z-50 border-b-2 border-blue-500">
                        <div>
                            <h1 className="text-xl font-bold text-gray-800 flex items-center">
                                <span className="mr-2"><IconFileText /></span> 附表八 填寫系統
                            </h1>
                            {lastSavedTime && <p className="text-xs text-gray-500 mt-1">上次存檔：{lastSavedTime}</p>}
                        </div>
                        <div className="flex space-x-3">
                            <button onClick={handleClear} className="px-4 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 text-sm flex items-center transition-colors">
                                <span className="mr-1"><IconTrash /></span> 清空
                            </button>
                            <button onClick={handleSaveDraft} disabled={isSaving} className="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm flex items-center transition-colors">
                                <span className="mr-1"><IconSave /></span> {isSaving ? '儲存中...' : '暫存'}
                            </button>
                            <button onClick={handleDownloadPDF} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold flex items-center shadow transition-colors">
                                <span className="mr-1"><IconDownload /></span> 下載 PDF
                            </button>
                        </div>
                    </div>

                    {/* A4 預覽與列印區 */}
                    <div id="print-area" className="max-w-[210mm] mx-auto bg-white shadow-2xl p-[15mm] min-h-[297mm] relative leading-snug box-border text-black">
                        
                        <div className="text-center mb-4">
                            <h2 className="text-xl font-bold mb-4 tracking-widest">附表八  勞工健康服務執行紀錄表</h2>
                        </div>

                        <div className="border-2 border-black">
                            
                            {/* 一、作業場所基本資料 */}
                            <div className={`${borderB} bg-gray-200 p-1 font-bold text-sm print:bg-gray-100`}>
                                一、作業場所基本資料
                            </div>
                            
                            <div className={`grid grid-cols-12 ${borderB}`}>
                                <div className={`col-span-2 ${cellLabel}`}>部門名稱</div>
                                <div className="col-span-10 p-2">
                                    <input type="text" name="deptName" value={formData.deptName} onChange={handleChange} className={`w-full bg-transparent outline-none ${placeholderClass}`} placeholder="輸入部門名稱" />
                                </div>
                            </div>

                            <div className={`grid grid-cols-12 ${borderB}`}>
                                <div className={`col-span-2 ${cellLabel} row-span-2`}>
                                    作業人員<br/>與人數
                                </div>
                                {/* 行政人員列 */}
                                <div className={`col-span-10 ${borderB} flex items-center p-2 flex-wrap gap-2`}>
                                    <label className="flex items-center cursor-pointer mr-2 select-none">
                                        <input type="checkbox" name="worker_admin" checked={formData.worker_admin} onChange={handleChange} className="w-4 h-4 mr-1 accent-black"/>
                                        行政人員：
                                    </label>
                                    <span className="mr-1">男</span>
                                    <input type="number" name="worker_admin_male" value={formData.worker_admin_male} onChange={handleChange} className={`w-12 border-b border-gray-400 text-center outline-none bg-transparent ${placeholderClass}`} placeholder="0" />
                                    <span className="mr-1">人；女</span>
                                    <input type="number" name="worker_admin_female" value={formData.worker_admin_female} onChange={handleChange} className={`w-12 border-b border-gray-400 text-center outline-none bg-transparent ${placeholderClass}`} placeholder="0" />
                                    <span>人</span>
                                </div>
                                {/* 現場操作人員列 */}
                                <div className="col-span-10 flex items-center p-2 flex-wrap gap-2">
                                    <label className="flex items-center cursor-pointer mr-2 select-none">
                                        <input type="checkbox" name="worker_site" checked={formData.worker_site} onChange={handleChange} className="w-4 h-4 mr-1 accent-black"/>
                                        現場操作人員：
                                    </label>
                                    <span className="mr-1">男</span>
                                    <input type="number" name="worker_site_male" value={formData.worker_site_male} onChange={handleChange} className={`w-12 border-b border-gray-400 text-center outline-none bg-transparent ${placeholderClass}`} placeholder="0" />
                                    <span className="mr-1">人；女</span>
                                    <input type="number" name="worker_site_female" value={formData.worker_site_female} onChange={handleChange} className={`w-12 border-b border-gray-400 text-center outline-none bg-transparent ${placeholderClass}`} placeholder="0" />
                                    <span>人</span>
                                </div>
                            </div>

                            <div className={`grid grid-cols-12 ${borderB}`}>
                                <div className={`col-span-2 ${cellLabel}`}>作業類別</div>
                                <div className="col-span-10 p-2 space-y-2">
                                    <div className="flex items-center gap-2">
                                        <span>一般作業：人數：</span>
                                        <input type="text" name="job_general_count" value={formData.job_general_count} onChange={handleChange} className={`w-20 border-b border-gray-400 text-center outline-none bg-transparent ${placeholderClass}`} placeholder="人數" />
                                    </div>
                                    <div className="flex items-center gap-2 flex-wrap">
                                        <label className="flex items-center cursor-pointer select-none">
                                            <input type="checkbox" name="job_special" checked={formData.job_special} onChange={handleChange} className="w-4 h-4 mr-1 accent-black"/>
                                            特別危害健康作業：類別：
                                        </label>
                                        <input type="text" name="job_special_cat" value={formData.job_special_cat} onChange={handleChange} className={`flex-1 min-w-[100px] border-b border-gray-400 outline-none bg-transparent ${placeholderClass}`} placeholder="例如：噪音、粉塵" />
                                        <span>人數：</span>
                                        <input type="text" name="job_special_count" value={formData.job_special_count} onChange={handleChange} className={`w-20 border-b border-gray-400 text-center outline-none bg-transparent ${placeholderClass}`} placeholder="人數" />
                                    </div>
                                </div>
                            </div>

                            {/* 二、概況 */}
                            <div className={`${borderB} p-2`}>
                                <div className="font-bold mb-1 text-sm">
                                    二、作業場所與勞動條件概況：工作流程(製程)、工作型態與時間、人員及危害特性概述
                                </div>
                                <textarea 
                                    name="conditions_overview" 
                                    value={formData.conditions_overview} 
                                    onChange={handleChange}
                                    rows="4" 
                                    className={`w-full p-1 resize-none outline-none bg-transparent ${placeholderClass}`} 
                                    placeholder="請簡述作業流程、輪班制度、工作時間及主要危害因子（如：噪音、化學品、人因工程風險等）..."
                                />
                            </div>

                            {/* 三、執行情形 */}
                            <div className={`${borderB}`}>
                                <div className={`p-2 font-bold ${borderB} bg-gray-50 print:bg-gray-50 text-sm`}>
                                    三、臨場健康服務執行情形(本規則第九條至第十三條事項)：
                                </div>
                                <div className={`grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-black min-h-[220px]`}>
                                    <div className="p-2 flex flex-col">
                                        <span className="font-bold mb-1 text-sm">(一) 辦理事項</span>
                                        <textarea 
                                            name="execution_items" 
                                            value={formData.execution_items} 
                                            onChange={handleChange}
                                            className={`flex-1 w-full resize-none outline-none bg-transparent ${placeholderClass}`} 
                                            placeholder="1. 健康檢查結果分析...&#10;2. 適性配工評估...&#10;3. 母性健康保護..."
                                        />
                                    </div>
                                    <div className="p-2 flex flex-col">
                                        <span className="font-bold mb-1 text-sm">(二) 發現問題</span>
                                        <textarea 
                                            name="problems_found" 
                                            value={formData.problems_found} 
                                            onChange={handleChange}
                                            className={`flex-1 w-full resize-none outline-none bg-transparent ${placeholderClass}`} 
                                            placeholder="1. 部分員工聽力檢查異常...&#10;2. 搬運姿勢不良..."
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* 四、建議採行措施 */}
                            <div className={`${borderB} p-2 min-h-[120px]`}>
                                <div className="font-bold mb-1 text-sm">
                                    四、建議採行措施：(針對發現問題所採行之措施)
                                </div>
                                <textarea 
                                    name="measures" 
                                    value={formData.measures} 
                                    onChange={handleChange}
                                    className={`w-full h-[80px] resize-none outline-none bg-transparent ${placeholderClass}`} 
                                    placeholder="建議加強聽力防護具配戴稽核、安排人因工程教育訓練..."
                                />
                            </div>

                            {/* 五、追蹤辦理情形 */}
                            <div className={`${borderB} p-2 min-h-[120px]`}>
                                <div className="font-bold mb-1 text-sm">
                                    五、對於前次建議改善事項之追蹤辦理情形：
                                </div>
                                <textarea 
                                    name="tracking" 
                                    value={formData.tracking} 
                                    onChange={handleChange}
                                    className={`w-full h-[80px] resize-none outline-none bg-transparent ${placeholderClass}`} 
                                    placeholder="前次建議之通風改善工程已於上月完成，目前監測數值正常..."
                                />
                            </div>

                            {/* 六、執行人員及日期 */}
                            <div className="p-2">
                                <div className="font-bold mb-2 text-sm">
                                    六、執行人員及日期(僅就當次實際執行者簽章)
                                </div>
                                
                                {/* 簽名勾選區 */}
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 pl-2 text-sm">
                                    <label className="flex items-center cursor-pointer select-none">
                                        <input type="checkbox" name="sign_doc" checked={formData.sign_doc} onChange={handleChange} className="w-4 h-4 mr-2 accent-black"/>
                                        勞工健康服務之醫師，簽章：
                                        {formData.sign_doc && <span className="ml-2 font-kai text-lg text-blue-800">(已簽署)</span>}
                                    </label>
                                    <label className="flex items-center cursor-pointer select-none">
                                        <input type="checkbox" name="sign_nurse" checked={formData.sign_nurse} onChange={handleChange} className="w-4 h-4 mr-2 accent-black"/>
                                        勞工健康服務之護理人員，簽章：
                                        {formData.sign_nurse && <span className="ml-2 font-kai text-lg text-blue-800">(已簽署)</span>}
                                    </label>
                                    <label className="flex items-center cursor-pointer select-none">
                                        <input type="checkbox" name="sign_related" checked={formData.sign_related} onChange={handleChange} className="w-4 h-4 mr-2 accent-black"/>
                                        勞工健康服務相關人員，簽章：
                                        {formData.sign_related && <span className="ml-2 font-kai text-lg text-blue-800">(已簽署)</span>}
                                    </label>
                                    <label className="flex items-center cursor-pointer select-none">
                                        <input type="checkbox" name="sign_osha" checked={formData.sign_osha} onChange={handleChange} className="w-4 h-4 mr-2 accent-black"/>
                                        職業安全衛生人員，簽章：
                                        {formData.sign_osha && <span className="ml-2 font-kai text-lg text-blue-800">(已簽署)</span>}
                                    </label>
                                    <label className="flex items-center cursor-pointer select-none">
                                        <input type="checkbox" name="sign_hr" checked={formData.sign_hr} onChange={handleChange} className="w-4 h-4 mr-2 accent-black"/>
                                        人力資源管理人員，簽章：
                                        {formData.sign_hr && <span className="ml-2 font-kai text-lg text-blue-800">(已簽署)</span>}
                                    </label>
                                </div>

                                {/* 部門主管與日期時間 */}
                                <div className="border-t border-dashed border-gray-400 pt-4 mt-2 flex flex-wrap items-end gap-4 text-sm">
                                    <div className="flex items-center flex-wrap gap-y-2">
                                        部門名稱：
                                        <input type="text" name="sup_dept_name" value={formData.sup_dept_name} onChange={handleChange} className={`w-24 border-b border-black outline-none text-center bg-transparent ${placeholderClass}`} placeholder="名稱"/>
                                        ，主管職稱：
                                        <input type="text" name="sup_title" value={formData.sup_title} onChange={handleChange} className={`w-24 border-b border-black outline-none text-center bg-transparent ${placeholderClass}`} placeholder="職稱"/>
                                        ，簽章：
                                        <input type="text" name="sup_sign" value={formData.sup_sign} onChange={handleChange} className={`w-24 border-b border-black outline-none text-center font-kai text-lg bg-transparent ${placeholderClass}`} placeholder="(簽名)"/>
                                    </div>
                                    
                                    <div className="flex items-center w-full sm:w-auto mt-2 sm:mt-0">
                                        時間：
                                        <input type="text" name="time_start_h" value={formData.time_start_h} onChange={handleChange} className="w-8 border-b border-black text-center outline-none bg-transparent"/>時
                                        <input type="text" name="time_start_m" value={formData.time_start_m} onChange={handleChange} className="w-8 border-b border-black text-center outline-none bg-transparent"/>分
                                        <span className="mx-1">迄</span>
                                        <input type="text" name="time_end_h" value={formData.time_end_h} onChange={handleChange} className="w-8 border-b border-black text-center outline-none bg-transparent"/>時
                                        <input type="text" name="time_end_m" value={formData.time_end_m} onChange={handleChange} className="w-8 border-b border-black text-center outline-none bg-transparent"/>分
                                    </div>

                                    <div className="flex items-center w-full sm:w-auto mt-2 sm:mt-0 ml-auto">
                                        執行日期：
                                        <input type="text" name="exec_year" value={formData.exec_year} onChange={handleChange} className="w-12 border-b border-black text-center outline-none bg-transparent" placeholder="113"/>年
                                        <input type="text" name="exec_month" value={formData.exec_month} onChange={handleChange} className="w-8 border-b border-black text-center outline-none bg-transparent" placeholder="01"/>月
                                        <input type="text" name="exec_day" value={formData.exec_day} onChange={handleChange} className="w-8 border-b border-black text-center outline-none bg-transparent" placeholder="01"/>日
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="max-w-[210mm] mx-auto mt-4 text-center text-gray-500 text-xs no-print">
                        附註：依照法規規定，紀錄應保存三年以上。表格內藍字為輸入提示，列印時將自動隱藏。
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
