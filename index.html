<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹å·¥å¥åº·é¡§å•ç®¡ç†ç³»çµ± - è‡¨å ´æœå‹™èˆ‡è©•é‘‘æ”¯æ´å¹³å°</title>
    <style>
        :root {
            --primary-color: #0056b3; /* å°ˆæ¥­è— */
            --primary-dark: #004494;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --text-color: #333;
        }

        * {
            box-sizing: border-box;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 15px;
        }

        /* --- é ‚éƒ¨å°è¦½åˆ— --- */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .system-title {
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-switcher {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 5px 15px;
            border-radius: 4px;
        }

        select#role-select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #fff;
            font-size: 0.95rem;
            background: white;
            color: #333;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- ä¸»è¦å…§å®¹å€å¡Š --- */
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            min-height: 80vh;
        }

        .view-section {
            display: none; /* é è¨­éš±è— */
            animation: fadeIn 0.3s ease-in;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- å„€è¡¨æ¿å¡ç‰‡ --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-card h3 { margin: 0 0 10px 0; color: var(--secondary-color); font-size: 0.9rem; }
        .stat-card .number { font-size: 2rem; font-weight: bold; color: var(--text-color); }
        .stat-card.green { border-left-color: var(--success-color); }
        .stat-card.yellow { border-left-color: var(--warning-color); }
        .stat-card.red { border-left-color: var(--danger-color); }

        /* --- é€šç”¨å®¹å™¨èˆ‡è¡¨æ ¼ --- */
        .card-container {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .section-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
        }

        .section-header h2 { margin: 0; font-size: 1.1rem; color: var(--primary-color); font-weight: bold; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
            white-space: nowrap;
        }

        tr:hover { background-color: #f1f3f5; }

        /* --- ç‹€æ…‹æ¨™ç±¤ --- */
        .badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
        }
        .badge-success { background-color: #d4edda; color: #155724; }
        .badge-warning { background-color: #fff3cd; color: #856404; }
        .badge-danger { background-color: #f8d7da; color: #721c24; }
        .badge-secondary { background-color: #e2e3e5; color: #383d41; }
        .badge-info { background-color: #d1ecf1; color: #0c5460; }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }
        .btn:hover { opacity: 0.9; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-outline { border: 1px solid var(--primary-color); background: white; color: var(--primary-color); }
        .btn-outline:hover { background: #e7f1ff; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }

        /* --- æ¨¹ç‹€çµæ§‹ (Tree View) --- */
        .tree-view { padding: 1.5rem; }
        .tree-node {
            margin-left: 20px;
            border-left: 2px solid #e9ecef;
            padding-left: 15px;
            margin-bottom: 10px;
        }
        .tree-header {
            font-weight: bold;
            padding: 8px 12px;
            background: #f1f3f5;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }
        .missing-item {
            border: 1px solid #f5c6cb;
            background: #fff5f5;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            color: #721c24;
        }

        /* --- è¡¨å–®æ¨£å¼ --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group.full-width { grid-column: span 2; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #495057; }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1rem;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,86,179,0.25);
        }
        
        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            padding: 8px 0;
        }
        .checkbox-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        /* --- è§’è‰²æç¤ºæ¢ --- */
        .role-alert {
            background-color: #fff3cd;
            color: #856404;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 5px solid #ffeeba;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- è©•é‘‘æ¨¡å¼å°ˆç”¨æ¨£å¼ (Inspector) --- */
        .inspector-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background-color: #e9ecef;
        }

        .accordion-item {
            border-bottom: 1px solid var(--border-color);
        }

        .accordion-header {
            padding: 15px 20px;
            background: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .accordion-header:hover { background: #f8f9fa; }
        .accordion-header.active { background: #f1f3f5; border-left: 4px solid var(--primary-color); }

        .accordion-content {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        .accordion-content.show { display: block; }

        .report-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .report-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #555;
            font-size: 0.9em;
        }

        .inspector-item-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .inspector-item-row:last-child { border-bottom: none; }
        .inspector-item-row.missing { color: var(--danger-color); font-weight: 500; }

        /* Helper Classes */
        .hidden { display: none !important; }
        .text-muted { color: #6c757d; font-size: 0.9em; }

        /* Modal æ¨¡æ“¬ (ä½¿ç”¨å…¨å±è¦†è“‹) */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <header>
        <div class="system-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            <span>å¥åº·é¡§å•è‡¨å ´æœå‹™ç®¡ç†å¹³å°</span>
        </div>
        <div class="role-switcher">
            <label for="role-select">ğŸ‘¤ ç•¶å‰è¦–è§’ï¼š</label>
            <select id="role-select" onchange="switchRole(this.value)">
                <option value="nurse">é¡§å•äººå“¡ï¼ˆè­·ç†ï¼é†«äº‹äººå“¡ï¼‰</option>
                <option value="admin" selected>é¡§å•æ©Ÿæ§‹ç®¡ç†äººå“¡</option>
                <option value="inspector">è©•é‘‘æº–å‚™æ¨¡å¼ (å”¯è®€)</option>
            </select>
        </div>
    </header>

    <main>
        <!-- è§’è‰²æç¤º -->
        <div id="role-alert" class="role-alert"></div>

        <!-- ======================= -->
        <!-- 1. ç¸½å…¬å¸ç®¡ç†å“¡ä»‹é¢ -->
        <!-- ======================= -->
        <section id="view-admin" class="view-section active">
            
            <!-- ç®¡ç†æ•¸æ“šå„€è¡¨æ¿ -->
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>æœå‹™äº‹æ¥­å–®ä½ç¸½æ•¸</h3>
                    <div class="number" id="admin-stat-total">0</div>
                </div>
                <div class="stat-card green">
                    <h3>ç´€éŒ„å®Œæ•´ (Pass)</h3>
                    <div class="number" id="admin-stat-green">0</div>
                </div>
                <div class="stat-card yellow">
                    <h3>å¾…è£œä»¶ (Warning)</h3>
                    <div class="number" id="admin-stat-yellow">0</div>
                </div>
                <div class="stat-card red">
                    <h3>æœªå®Œæˆ/ç¼ºä»¶åš´é‡</h3>
                    <div class="number" id="admin-stat-red">0</div>
                </div>
            </div>

            <!-- æ¡ˆå ´ç®¡ç†åˆ—è¡¨ -->
            <div class="card-container">
                <div class="section-header">
                    <h2>ğŸ¢ äº‹æ¥­å–®ä½ç¶­è­·èˆ‡ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="openAdminSiteForm()">ï¼‹ æ–°å¢æœå‹™åˆç´„</button>
                </div>
                <table id="admin-site-table">
                    <thead>
                        <tr>
                            <th>äº‹æ¥­å–®ä½åç¨± / çµ±ç·¨</th>
                            <th>åˆç´„æœŸé–“</th>
                            <th>æŒ‡æ´¾é¡§å•</th>
                            <th>æœå‹™é¡å‹</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS Render -->
                    </tbody>
                </table>
            </div>

            <!-- æ¡ˆå ´è©³æƒ… (éš±è—å€å¡Š) -->
            <div id="admin-site-detail" class="card-container hidden">
                <div class="section-header" style="background: #e7f1ff;">
                    <h2 id="detail-title">æœå‹™å–®ä½è©³æƒ…</h2>
                    <button class="btn btn-outline btn-sm" onclick="closeAdminDetail()">âœ– é—œé–‰è©³æƒ…</button>
                </div>
                <div class="tree-view" id="detail-content">
                    <!-- JS Render Tree -->
                </div>
            </div>
        </section>

        <!-- ======================= -->
        <!-- 2. å‰ç«¯è·è­·äººå“¡ä»‹é¢ -->
        <!-- ======================= -->
        <section id="view-nurse" class="view-section">
            <div class="card-container">
                <div class="section-header">
                    <h2>ğŸ¥ è² è²¬æœå‹™äº‹æ¥­å–®ä½</h2>
                    <span class="text-muted">åƒ…é¡¯ç¤ºæ‚¨è¢«æŒ‡æ´¾ä¹‹è‡¨å ´æœå‹™å–®ä½</span>
                </div>
                <table id="nurse-site-table">
                    <thead>
                        <tr>
                            <th>äº‹æ¥­å–®ä½åç¨±</th>
                            <th>æœå‹™é¡å‹</th>
                            <th>æœ€è¿‘ä¸€æ¬¡æœå‹™</th>
                            <th>å¾…è¾¦äº‹é …</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS Render -->
                    </tbody>
                </table>
            </div>

            <!-- è·è­·å¡«å ±å€ (éš±è—) -->
            <div id="nurse-report-form" class="card-container hidden">
                <div class="section-header" style="background: #fff3cd;">
                    <h2 id="nurse-report-title">ğŸ“ è‡¨å ´æœå‹™ç´€éŒ„å¡«å ±</h2>
                    <button class="btn btn-outline btn-sm" onclick="closeNurseReport()">å–æ¶ˆè¿”å›</button>
                </div>
                <div style="padding: 20px;">
                    <div class="form-group">
                        <label>è‡¨å ´æœå‹™æ—¥æœŸï¼š</label>
                        <input type="date" class="form-control" id="report-date" value="2024-10-20">
                    </div>
                    
                    <div class="form-group">
                        <label>å¥åº·æŒ‡å°å»ºè­°èˆ‡ä½è­‰è³‡æ–™ï¼š</label>
                        <div id="suggestion-container" style="border:1px solid #eee; padding:10px; border-radius:4px; background:#fafafa;">
                            <!-- å‹•æ…‹é …ç›® -->
                        </div>
                        <button class="btn btn-outline btn-sm" style="margin-top:10px;" onclick="addSuggestionRow()">ï¼‹ æ–°å¢å»ºè­°äº‹é …</button>
                    </div>

                    <div style="margin-top:20px; text-align:right; border-top:1px solid #eee; padding-top:15px;">
                        <button class="btn btn-primary" onclick="submitNurseReport()">ğŸ’¾ æäº¤ç´€éŒ„ä¸¦å­˜æª”</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ======================= -->
        <!-- 3. å°ˆä»»è² è²¬äººä»‹é¢ (Inspector View) -->
        <!-- ======================= -->
        <section id="view-inspector" class="view-section">
            <div class="card-container">
                <!-- é ‚éƒ¨å·¥å…·åˆ—ï¼šå¹´åº¦é¸æ“‡ -->
                <div class="inspector-toolbar">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <h2 style="margin:0; font-size:1.1rem; color:var(--text-color);">ğŸ” è©•é‘‘æº–å‚™æ¨¡å¼</h2>
                        <span class="badge badge-info">å”¯è®€æ¬Šé™</span>
                    </div>
                    <div>
                        <label for="inspector-year" style="font-weight:bold; margin-right:5px;">è©•é‘‘å¹´åº¦ï¼š</label>
                        <select id="inspector-year" class="form-control" style="width:auto; display:inline-block;" onchange="renderInspectorView(this.value)">
                            <option value="2024">2024 å¹´åº¦</option>
                            <option value="2023">2023 å¹´åº¦</option>
                        </select>
                        <button class="btn btn-success btn-sm" style="margin-left:10px;" onclick="exportData()">ğŸ“¥ åŒ¯å‡ºå¹´åº¦æœå‹™ç´€éŒ„å½™æ•´</button>
                    </div>
                </div>

                <!-- Accordion å®¹å™¨ -->
                <div id="inspector-accordion-container">
                    <!-- JS Render Accordion -->
                </div>
            </div>
        </section>

    </main>

    <!-- Modal: æ–°å¢/ç·¨è¼¯æ¡ˆå ´ (Admin Only) -->
    <div id="admin-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="section-header">
                <h2>ğŸ¢ æ–°å¢/ç·¨è¼¯ äº‹æ¥­å–®ä½åˆç´„è³‡æ–™</h2>
                <button class="btn btn-sm btn-outline" onclick="closeAdminModal()">âœ–</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>äº‹æ¥­å–®ä½åç¨± <span style="color:red">*</span></label>
                    <input type="text" id="site-name" class="form-control" placeholder="ä¾‹å¦‚ï¼šå°ç©é›»ä¸­ç§‘å» ">
                </div>
                <div class="form-group">
                    <label>çµ±ä¸€ç·¨è™Ÿ / è­˜åˆ¥ç¢¼</label>
                    <input type="text" id="site-taxid" class="form-control" placeholder="12345678">
                </div>
                <div class="form-group">
                    <label>æœå‹™é¡å‹</label>
                    <select id="site-type" class="form-control">
                        <option value="è‡¨å ´æœå‹™">è‡¨å ´æœå‹™ (é†«å¸«/è­·ç†äººå“¡)</option>
                        <option value="ç‰¹ç´„å°ˆæ¡ˆ">ç‰¹ç´„å°ˆæ¡ˆ</option>
                        <option value="è¼”å°æ”¹å–„">è¼”å°æ”¹å–„è¨ˆç•«</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆç´„ç‹€æ…‹</label>
                    <select id="site-status" class="form-control">
                        <option value="active">ğŸŸ¢ é€²è¡Œä¸­</option>
                        <option value="closed">ğŸ”´ å·²çµæ¡ˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆç´„é–‹å§‹æ—¥</label>
                    <input type="date" id="site-start" class="form-control">
                </div>
                <div class="form-group">
                    <label>åˆç´„çµæŸæ—¥</label>
                    <input type="date" id="site-end" class="form-control">
                </div>
                <div class="form-group full-width">
                    <label>æŒ‡æ´¾é¡§å•äººå“¡ (å¯å¤šé¸)</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="nurse" value="é™³å°ç¾"> é™³å°ç¾ (è­·ç†å¸«)</label>
                        <label><input type="checkbox" name="nurse" value="å¼µå¿—æ˜"> å¼µå¿—æ˜ (è·è¡›å¸«)</label>
                        <label><input type="checkbox" name="nurse" value="ææ˜¥å¬Œ"> ææ˜¥å¬Œ (è·è¡›å¸«)</label>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>å‚™è¨»èªªæ˜</label>
                    <textarea id="site-remark" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div style="padding: 1.5rem; background:#f8f9fa; text-align:right; border-top:1px solid #eee;">
                <button class="btn btn-outline" onclick="closeAdminModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveSite()">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. Mock Data & State Management
        // ==========================================
        const appState = {
            role: 'admin', // ç•¶å‰è§’è‰²
            sites: [
                { 
                    id: 1, 
                    name: "ç§‘æŠ€åœ’å€ A å»  (é›»å­æ¥­)", 
                    taxId: "80123456",
                    type: "è‡¨å ´æœå‹™",
                    contractStart: "2023-01-01",
                    contractEnd: "2024-12-31",
                    nurses: ["é™³å°ç¾"],
                    status: "active",
                    lastUpdate: "2024-03-15"
                },
                { 
                    id: 2, 
                    name: "å‚³ç”¢åŠ å·¥ B å»  (é‡‘å±¬)", 
                    taxId: "22334455",
                    type: "è¼”å°æ”¹å–„",
                    contractStart: "2023-06-01",
                    contractEnd: "2024-05-31",
                    nurses: ["å¼µå¿—æ˜"],
                    status: "active",
                    lastUpdate: "2024-02-20"
                },
                { 
                    id: 3, 
                    name: "ç‰©æµä¸­å¿ƒ C å» ", 
                    taxId: "55667788",
                    type: "è‡¨å ´æœå‹™",
                    contractStart: "2024-01-01",
                    contractEnd: "2024-12-31",
                    nurses: ["ææ˜¥å¬Œ"],
                    status: "active",
                    lastUpdate: "2024-01-10"
                }
            ],
            reports: [
                // 2023 Data
                {
                    id: 101, siteId: 1, year: 2023, date: "2023-10-01", author: "é™³å°ç¾",
                    items: [
                        { content: "æ€¥æ•‘äººå“¡è­‰ç…§å·²éæœŸ", hasFile: true },
                        { content: "åŒ–å­¸å“å¥åº·å±å®³è©•ä¼°æœªæ›´æ–°", hasFile: false } // ç¼ºå¤±
                    ]
                },
                {
                    id: 102, siteId: 2, year: 2023, date: "2023-09-28", author: "å¼µå¿—æ˜",
                    items: [
                        { content: "ç‰¹ä½œå¥æª¢åˆ†ç´šç®¡ç†ç´€éŒ„ç•°å¸¸", hasFile: false } // ç¼ºå¤±
                    ]
                },
                // 2024 Data
                {
                    id: 201, siteId: 1, year: 2024, date: "2024-03-15", author: "é™³å°ç¾",
                    items: [
                        { content: "å››å¤§è¨ˆç•«ä¹‹åŸ·è¡Œç´€éŒ„ä¸å…¨", hasFile: true },
                        { content: "å™ªéŸ³ä½œæ¥­å€è½åŠ›ä¿è­·å…·ä½©æˆ´æŒ‡å°ç´€éŒ„ç¼ºæ¼", hasFile: true }
                    ]
                },
                {
                    id: 202, siteId: 2, year: 2024, date: "2024-02-20", author: "å¼µå¿—æ˜",
                    items: [
                        { content: "æœ‰æ©Ÿæº¶åŠ‘ä½œæ¥­äººå“¡å¥æª¢çµæœåˆ†ææœªå®Œæˆ", hasFile: false }, // ç¼ºå¤±
                        { content: "å‘¼å¸é˜²è­·è¨ˆç•«æœªè½å¯¦åŸ·è¡Œ", hasFile: true }
                    ]
                }
                // Site 3 (id:3) åœ¨ 2024 å¹´å°šç„¡ç´€éŒ„
            ]
        };

        // æ¨¡æ“¬ç•¶å‰ç™»å…¥çš„è·è­·åç¨± (ç”¨æ–¼æ¿¾ç¶²)
        const CURRENT_NURSE_NAME = "é™³å°ç¾"; 

        // ==========================================
        // 2. Initialization & Role Switching
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            switchRole('admin');
        });

        function switchRole(role) {
            appState.role = role;
            
            // UI Toggle
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const alertBox = document.getElementById('role-alert');
            
            if (role === 'admin') {
                document.getElementById('view-admin').classList.add('active');
                alertBox.innerHTML = "<strong>ğŸ‘¨â€ğŸ’¼ é¡§å•æ©Ÿæ§‹ç®¡ç†äººå“¡</strong>ï¼šæ‚¨æ“æœ‰æœ€é«˜æ¬Šé™ï¼Œå¯æ–°å¢ã€ç·¨è¼¯äº‹æ¥­å–®ä½åˆç´„ï¼Œä¸¦æª¢è¦–æ‰€æœ‰å¾…è£œæ­£äº‹é …ã€‚";
                alertBox.className = "role-alert"; 
                renderAdminView();
            } else if (role === 'nurse') {
                document.getElementById('view-nurse').classList.add('active');
                alertBox.innerHTML = `<strong>ğŸ‘©â€âš•ï¸ é¡§å•äººå“¡ (${CURRENT_NURSE_NAME})</strong>ï¼šæ‚¨åƒ…èƒ½æª¢è¦–è¢«æŒ‡æ´¾çš„äº‹æ¥­å–®ä½ï¼Œä¸¦é€²è¡Œè‡¨å ´æœå‹™ç´€éŒ„å¡«å ±ã€‚`;
                alertBox.style.backgroundColor = "#d1ecf1";
                alertBox.style.color = "#0c5460";
                alertBox.style.borderColor = "#bee5eb";
                renderNurseView();
            } else if (role === 'inspector') {
                document.getElementById('view-inspector').classList.add('active');
                alertBox.innerHTML = "<strong>ğŸ§ è©•é‘‘æº–å‚™æ¨¡å¼</strong>ï¼šå”¯è®€æ¨¡å¼ï¼Œåƒ…ä¾›å…§éƒ¨å½™æ•´æˆ–ä¸»ç®¡æ©Ÿé—œæŸ¥æ ¸å±•ç¤ºä½¿ç”¨ã€‚";
                alertBox.style.backgroundColor = "#e2e3e5";
                alertBox.style.color = "#383d41";
                alertBox.style.borderColor = "#d6d8db";
                
                // åˆå§‹åŒ–è©•é‘‘è¦–åœ–ï¼Œé è¨­ 2024
                document.getElementById('inspector-year').value = "2024";
                renderInspectorView("2024");
            }
        }

        // ==========================================
        // 3. Admin Logic (CRUD)
        // ==========================================
        function renderAdminView() {
            // 1. Update Stats (Global)
            let total = appState.sites.length;
            let green = 0, yellow = 0, red = 0;

            appState.sites.forEach(site => {
                const status = getSiteComplianceStatus(site.id); // è®¡ç®—å…¨å¹´åº¦
                if(status === 'green') green++;
                else if(status === 'yellow') yellow++;
                else red++;
            });

            document.getElementById('admin-stat-total').innerText = total;
            document.getElementById('admin-stat-green').innerText = green;
            document.getElementById('admin-stat-yellow').innerText = yellow;
            document.getElementById('admin-stat-red').innerText = red;

            // 2. Render Table
            const tbody = document.querySelector('#admin-site-table tbody');
            tbody.innerHTML = '';

            appState.sites.forEach(site => {
                const statusBadge = site.status === 'active' 
                    ? '<span class="badge badge-success">é€²è¡Œä¸­</span>' 
                    : '<span class="badge badge-secondary">å·²çµæ¡ˆ</span>';
                
                const compliance = getSiteComplianceStatus(site.id);
                const complianceDot = compliance === 'red' ? 'ğŸ”´' : (compliance === 'yellow' ? 'ğŸŸ¡' : 'ğŸŸ¢');

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div><strong>${site.name}</strong></div>
                            <small class="text-muted">çµ±ç·¨: ${site.taxId}</small>
                        </td>
                        <td>
                            <small>${site.contractStart} ~</small><br>
                            <small>${site.contractEnd}</small>
                        </td>
                        <td>${site.nurses.join(', ')}</td>
                        <td>${site.type}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="showAdminSiteDetail(${site.id})">ğŸ” è©³æƒ… ${complianceDot}</button>
                        </td>
                    </tr>
                `;
            });
        }

        // Add Site Modal
        function openAdminSiteForm() {
            document.getElementById('admin-modal').classList.remove('hidden');
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('site-name').value = '';
            document.getElementById('site-taxid').value = '';
            document.getElementById('site-start').value = '';
            document.getElementById('site-end').value = '';
            document.querySelectorAll('input[name="nurse"]').forEach(cb => cb.checked = false);
        }

        function closeAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
        }

        function saveSite() {
            const name = document.getElementById('site-name').value;
            if(!name) { alert('è«‹è¼¸å…¥äº‹æ¥­å–®ä½åç¨±'); return; }

            const nurses = Array.from(document.querySelectorAll('input[name="nurse"]:checked')).map(cb => cb.value);

            const newSite = {
                id: Date.now(),
                name: name,
                taxId: document.getElementById('site-taxid').value || 'N/A',
                type: document.getElementById('site-type').value,
                status: document.getElementById('site-status').value,
                contractStart: document.getElementById('site-start').value || '2024-01-01',
                contractEnd: document.getElementById('site-end').value || '2024-12-31',
                nurses: nurses.length > 0 ? nurses : ['æœªæŒ‡æ´¾'],
                lastUpdate: new Date().toISOString().split('T')[0]
            };

            appState.sites.push(newSite);
            closeAdminModal();
            renderAdminView();
            alert('âœ… æœå‹™åˆç´„å·²æ–°å¢æˆåŠŸ');
        }

        // Site Detail View
        function showAdminSiteDetail(siteId) {
            const site = appState.sites.find(s => s.id === siteId);
            const siteReports = appState.reports.filter(r => r.siteId === siteId);
            
            document.getElementById('admin-site-detail').classList.remove('hidden');
            document.getElementById('detail-title').innerHTML = `ğŸ” ${site.name} <small style="font-weight:normal; font-size:0.8em">(${site.type})</small>`;
            
            const container = document.getElementById('detail-content');
            container.innerHTML = '';

            if(siteReports.length === 0) {
                container.innerHTML = '<p class="text-muted" style="text-align:center; padding:20px;">å°šç„¡æœå‹™ç´€éŒ„</p>';
                return;
            }

            siteReports.forEach(report => {
                let itemsHtml = '';
                report.items.forEach(item => {
                    const isMissing = !item.hasFile;
                    itemsHtml += `
                        <div class="tree-node ${isMissing ? 'missing-item' : ''}">
                            <div style="display:flex; justify-content:space-between;">
                                <span>${isMissing ? 'âš ï¸' : 'âœ…'} ${item.content}</span>
                                <span class="badge ${isMissing ? 'badge-danger' : 'badge-success'}">
                                    ${isMissing ? 'å¾…è£œä»¶' : 'å·²æ­¸æª”'}
                                </span>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML += `
                    <div style="margin-bottom:20px;">
                        <div class="tree-header">
                            <span>ğŸ“„ ${report.date} æœå‹™ç´€éŒ„ (${report.year})</span>
                            <small>é¡§å•äººå“¡: ${report.author}</small>
                        </div>
                        ${itemsHtml}
                    </div>
                `;
            });
            
            // Scroll to detail
            document.getElementById('admin-site-detail').scrollIntoView({behavior: "smooth"});
        }

        function closeAdminDetail() {
            document.getElementById('admin-site-detail').classList.add('hidden');
        }

        // ==========================================
        // 4. Nurse Logic
        // ==========================================
        let currentNurseSiteId = null;

        function renderNurseView() {
            const tbody = document.querySelector('#nurse-site-table tbody');
            tbody.innerHTML = '';

            // é—œéµé‚è¼¯ï¼šåªé¡¯ç¤ºæŒ‡æ´¾çµ¦ç›®å‰è·è­·çš„æ¡ˆå ´
            const mySites = appState.sites.filter(site => site.nurses.includes(CURRENT_NURSE_NAME));

            if(mySites.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">ç„¡æŒ‡æ´¾æœå‹™å–®ä½</td></tr>';
                return;
            }

            mySites.forEach(site => {
                const missingCount = getSiteMissingCount(site.id);
                const statusHtml = missingCount > 0 
                    ? `<span class="badge badge-danger">æœ‰ ${missingCount} é …å¾…è£œé™„ä»¶</span>`
                    : `<span class="badge badge-success">ç´€éŒ„å®Œæ•´</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${site.name}</strong></td>
                        <td>${site.type}</td>
                        <td>${site.lastUpdate}</td>
                        <td>${statusHtml}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openNurseReportForm(${site.id})">âœï¸ æ–°å¢æœå‹™ç´€éŒ„</button>
                        </td>
                    </tr>
                `;
            });
        }

        function openNurseReportForm(siteId) {
            currentNurseSiteId = siteId;
            const site = appState.sites.find(s => s.id === siteId);
            
            document.getElementById('nurse-report-form').classList.remove('hidden');
            document.getElementById('nurse-report-title').innerText = `ğŸ“ ${site.name} - æ–°å¢æœå‹™ç´€éŒ„`;
            document.getElementById('nurse-site-table').parentElement.classList.add('hidden'); // Hide list
            
            // Reset
            document.getElementById('suggestion-container').innerHTML = '';
            addSuggestionRow();
        }

        function closeNurseReport() {
            document.getElementById('nurse-report-form').classList.add('hidden');
            document.getElementById('nurse-site-table').parentElement.classList.remove('hidden');
        }

        function addSuggestionRow() {
            const div = document.createElement('div');
            div.className = 'tree-node';
            div.style.background = '#fff';
            div.style.padding = '10px';
            div.style.marginBottom = '10px';
            
            div.innerHTML = `
                <input type="text" class="form-control item-input" placeholder="è«‹è¼¸å…¥å¥åº·æŒ‡å°/æ”¹å–„å»ºè­°äº‹é …..." style="margin-bottom:5px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-size:0.9rem; cursor:pointer;">
                        <input type="checkbox" class="file-check"> å·²åŒ…å«ç…§ç‰‡/ä½è­‰è³‡æ–™
                    </label>
                    <button class="btn btn-outline btn-sm" style="color:#dc3545; border-color:#dc3545;" onclick="this.parentElement.parentElement.remove()">åˆªé™¤</button>
                </div>
            `;
            document.getElementById('suggestion-container').appendChild(div);
        }

        function submitNurseReport() {
            const dateStr = document.getElementById('report-date').value;
            const rows = document.querySelectorAll('#suggestion-container .tree-node');
            
            if(rows.length === 0) { alert('è«‹è‡³å°‘æ–°å¢ä¸€é …å»ºè­°'); return; }

            const newItems = [];
            rows.forEach(row => {
                const content = row.querySelector('.item-input').value;
                if(content) {
                    const hasFile = row.querySelector('.file-check').checked;
                    newItems.push({ content, hasFile });
                }
            });

            // Parse year from date string (YYYY-MM-DD)
            const year = parseInt(dateStr.split('-')[0]);

            // Update Mock DB
            appState.reports.push({
                id: Date.now(),
                siteId: currentNurseSiteId,
                year: year,
                date: dateStr,
                author: CURRENT_NURSE_NAME,
                items: newItems
            });

            // Update Site Time
            const site = appState.sites.find(s => s.id === currentNurseSiteId);
            site.lastUpdate = new Date().toISOString().split('T')[0];

            alert('âœ… ç´€éŒ„å·²æäº¤ï¼Œè³‡æ–™å·²å­˜æª”åŒæ­¥ã€‚');
            closeNurseReport();
            renderNurseView();
        }

        // ==========================================
        // 5. Inspector View (è©•é‘‘æ¨¡å¼) Logic
        // ==========================================
        
        function renderInspectorView(selectedYear) {
            const container = document.getElementById('inspector-accordion-container');
            container.innerHTML = '';
            
            const year = parseInt(selectedYear);

            appState.sites.forEach(site => {
                // Filter reports by site AND selected year
                const yearReports = appState.reports.filter(r => r.siteId === site.id && r.year === year);
                
                // Sort by date desc
                yearReports.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Calculate status for THIS year only
                let statusHtml = '';
                let statusClass = '';
                let missingCount = 0;

                if (yearReports.length === 0) {
                    statusHtml = '<span class="badge badge-secondary" style="background:#e2e3e5; color:#666;">ç„¡æœå‹™ç´€éŒ„</span>';
                    statusClass = 'no-record';
                } else {
                    missingCount = yearReports.reduce((acc, r) => acc + r.items.filter(i => !i.hasFile).length, 0);
                    if (missingCount >= 2) {
                        statusHtml = '<span class="badge badge-danger">å»ºè­°äº‹é …å°šæœªè£œé½Šé™„ä»¶ (2+)</span>';
                        statusClass = 'red';
                    } else if (missingCount > 0) {
                        statusHtml = '<span class="badge badge-warning">å»ºè­°äº‹é …å°šæœªè£œé½Šé™„ä»¶</span>';
                        statusClass = 'yellow';
                    } else {
                        statusHtml = '<span class="badge badge-success">ç´€éŒ„å®Œæ•´</span>';
                        statusClass = 'green';
                    }
                }

                // Generate Content
                let contentHtml = '';
                if (yearReports.length === 0) {
                    contentHtml = `<p class="text-muted" style="text-align:center;">è©²å¹´åº¦ï¼ˆ${year}ï¼‰æœªæä¾›å‹å·¥å¥åº·æœå‹™ã€‚</p>`;
                } else {
                    yearReports.forEach(report => {
                        let itemsList = '';
                        report.items.forEach(item => {
                            const icon = item.hasFile ? 'âœ…' : 'âš ï¸';
                            const itemClass = item.hasFile ? '' : 'missing';
                            const fileText = item.hasFile ? 'é™„ä»¶å·²å‚™' : 'å»ºè­°äº‹é …å°šæœªè£œé½Šé™„ä»¶';
                            itemsList += `
                                <div class="inspector-item-row ${itemClass}">
                                    <span>${icon} ${item.content}</span>
                                    <span style="font-size:0.85em;">${fileText}</span>
                                </div>
                            `;
                        });

                        contentHtml += `
                            <div class="report-card">
                                <div class="report-meta">
                                    <span>ğŸ“„ è‡¨å ´æœå‹™ç´€éŒ„ï¼š${report.date}</span>
                                    <span>é¡§å•äººå“¡ï¼š${report.author}</span>
                                </div>
                                <div>${itemsList}</div>
                            </div>
                        `;
                    });
                }

                // Append Accordion Item
                const accordionId = `acc-${site.id}`;
                container.innerHTML += `
                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleInspectorAccordion('${accordionId}')">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <strong>${site.name}</strong>
                                ${statusHtml}
                            </div>
                            <span style="color:#aaa;">â–¼</span>
                        </div>
                        <div id="${accordionId}" class="accordion-content">
                            ${contentHtml}
                        </div>
                    </div>
                `;
            });
        }

        function toggleInspectorAccordion(id) {
            const content = document.getElementById(id);
            const header = content.previousElementSibling;
            
            // Toggle current
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                header.classList.remove('active');
            } else {
                // Close others (optional, keep open allows comparison)
                document.querySelectorAll('.accordion-content').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.accordion-header').forEach(el => el.classList.remove('active'));
                
                content.classList.add('show');
                header.classList.add('active');
            }
        }

        function exportData() {
            const year = document.getElementById('inspector-year').value;
            alert(`ç³»çµ±æç¤ºï¼š\n\nå·²å°‡ ${year} å¹´åº¦ä¾å¹´åº¦å½™æ•´ä¹‹æœå‹™ç´€éŒ„èˆ‡é™„ä»¶åŒ¯å‡ºç‚º CSV æ ¼å¼ã€‚\n(æ­¤ç‚º Demo æ¨¡æ“¬åŠŸèƒ½)`);
        }

        // Helper: Calculate Status (Global / All time for Admin)
        function getSiteMissingCount(siteId) {
            const reports = appState.reports.filter(r => r.siteId === siteId);
            return reports.reduce((acc, r) => acc + r.items.filter(i => !i.hasFile).length, 0);
        }

        function getSiteComplianceStatus(siteId) {
            const missing = getSiteMissingCount(siteId);
            if (missing >= 2) return 'red';
            if (missing > 0) return 'yellow';
            return 'green';
        }

    </script>
</body>
</html>
